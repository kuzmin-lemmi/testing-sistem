<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç - {{ student.last_name }} {{ student.first_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
        }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .student-name { font-weight: 700; font-size: 1.1em; }
        .timer {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3em;
            font-weight: 700;
        }
        .timer.warning { background: var(--warning); }
        .timer.danger { background: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .btn-finish {
            background: white;
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-finish:hover { background: #f0f0f0; }
        .btn-finish:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .finish-note {
            font-size: 0.9em;
            opacity: 0.85;
        }
        .time-over-note {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-weight: 600;
            text-align: center;
        }
        
        .main { display: flex; min-height: calc(100vh - 70px); }
        
        .sidebar {
            width: 100px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }
        .task-btn {
            width: 100%;
            padding: 14px 8px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: 0.2s;
        }
        .task-btn:hover { border-color: var(--primary); }
        .task-btn.current { border-color: var(--primary); background: #eef2ff; }
        .task-btn.answered { border-color: var(--success); background: #d1fae5; }
        .task-btn.viewed { border-color: var(--warning); }
        .task-btn.unsaved {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        .task-btn .save-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 6px;
            vertical-align: middle;
        }
        .task-btn.unsaved .save-dot {
            background: #f59e0b;
        }
        
        .content { flex: 1; padding: 24px; max-width: 1100px; margin: 0 auto; }
        
        .task-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px 32px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .task-number {
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
        }
        .task-image { margin-bottom: 24px; text-align: center; }
        .task-image img { 
            max-width: 100%; 
            width: auto;
            min-width: 80%;
            max-height: 70vh;
            border-radius: 12px; 
            border: 1px solid var(--border);
            cursor: zoom-in;
            /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ 10% */
            transform: scale(1.0);
            transform-origin: top center;
        }
        .task-image img:hover {
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .task-image img.zoomed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            max-width: 98vw;
            max-height: 98vh;
            min-width: auto;
            width: auto;
            z-index: 1000;
            cursor: zoom-out;
            border-radius: 8px;
        }
        .zoom-hint {
            display: block;
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            margin-top: 8px;
        }
        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            display: none;
        }
        .zoom-overlay.active { display: block; }
        
        .attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #eef2ff;
            border-radius: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .attachment:hover { background: #e0e7ff; }
        
        .answer-section { margin-top: 24px; }
        .answer-section label { display: block; margin-bottom: 10px; font-weight: 600; }
        .answer-input {
            width: 200px;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 18px;
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }
        .answer-input:focus { outline: none; border-color: var(--primary); }
        .answer-row { display: flex; gap: 16px; flex-wrap: wrap; }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 12px;
        }
        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            font-size: 15px;
            border: none;
            transition: 0.2s;
        }
        .nav-btn.secondary { background: var(--bg); color: var(--text); }
        .nav-btn.primary { background: var(--primary); color: white; }
        .nav-btn.save { background: #e0e7ff; color: var(--primary); }
        .nav-btn:hover { transform: translateY(-2px); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .save-status {
            margin-top: 10px;
            color: var(--muted);
            font-size: 12px;
            text-align: center;
        }
        
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            opacity: 0;
            transition: 0.3s;
        }
        .save-indicator.show { opacity: 1; }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.92);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 24px;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 28px 32px;
            max-width: 420px;
        }

        .fullscreen-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .fullscreen-card p {
            opacity: 0.85;
            margin-bottom: 18px;
        }

        .fullscreen-btn {
            background: white;
            color: #1e293b;
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .fullscreen-warning {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            display: none;
            z-index: 1500;
        }

        .fullscreen-warning.active { display: flex; gap: 10px; align-items: center; }

        .pause-banner {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            display: none;
            z-index: 1400;
        }

        .pause-banner.active { display: block; }
        
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px 6px; }
            .content { padding: 16px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="student-name">{{ student.last_name }} {{ student.first_name }}</div>
        <div class="timer" id="timer">--:--</div>
        {% if teacher_finish_only %}
        <div class="finish-note">
            –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–º–∞–Ω–¥–µ —É—á–∏—Ç–µ–ª—è
        </div>
        <form action="{{ url_for('student_finish') }}" method="POST" id="finishForm">
            <button type="submit" class="btn-finish" disabled>
                –û–∂–∏–¥–∞–π—Ç–µ —É—á–∏—Ç–µ–ª—è
            </button>
        </form>
        {% else %}
        <form action="{{ url_for('student_finish') }}" method="POST" id="finishForm">
            <button type="submit" class="btn-finish" onclick="return confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
            </button>
        </form>
        {% endif %}
    </header>

    {% if app_mode %}
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-card">
            <h3>–≠–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º</h3>
            <p>–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª.</p>
            <button class="fullscreen-btn" onclick="enterFullscreen()">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
        </div>
    </div>
    <div class="fullscreen-warning" id="fullscreenWarning">
        <span>–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞</span>
        <button class="fullscreen-btn" onclick="enterFullscreen()">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>
    {% endif %}

    <div class="pause-banner" id="pauseOverlay">–ü–∞—É–∑–∞ —É—á–∏—Ç–µ–ª—è ‚Äî –≤–≤–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω</div>
    
    <div class="main">
        <aside class="sidebar">
            {% for task in tasks %}
            <button class="task-btn {% if loop.index0 == current_task %}current{% endif %} {% if task.id in answers %}answered{% endif %}"
                    onclick="goToTask({{ loop.index0 }})" data-task="{{ loop.index0 }}">
                {{ loop.index }}
                <span class="save-dot"></span>
            </button>
            {% endfor %}
        </aside>
        
        <main class="content">
            {% for task in tasks %}
            <div class="task-card" id="task-{{ loop.index0 }}" data-task-id="{{ task.id }}" style="{% if loop.index0 != current_task %}display:none{% endif %}">
                <div class="task-header">
                    <span class="task-number">–ó–∞–¥–∞–Ω–∏–µ {{ loop.index }} –∏–∑ {{ tasks|length }}</span>
                    <span style="color: var(--muted);">‚Ññ{{ task.ege_number }} –ï–ì–≠</span>
                </div>
                
                <div class="task-image">
                    <img src="{{ url_for('serve_image', filename=task.image_path) }}" alt="–ó–∞–¥–∞—á–∞" onclick="toggleZoom(this)">
                    <span class="zoom-hint">üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</span>
                </div>
                
                {% if task.attachment_path %}
                <a href="{{ url_for('serve_attachment', filename=task.attachment_path) }}" class="attachment" download>
                    üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö
                </a>
                {% endif %}
                
                <div class="answer-section">
                    <label>–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                    <div class="answer-row">
                        {% if task.answer_count == 0 %}
                        <textarea class="answer-input" style="width:100%; max-width:700px; height:140px; text-align:left; font-family: 'JetBrains Mono', monospace;"
                                  data-task-id="{{ task.id }}"
                                  data-answer="text"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç / –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫)"
                                  oninput="scheduleSave({{ task.id }})">{{ answers.get(task.id, {}).get('answer_text', '') or '' }}</textarea>
                        {% else %}
                        <input type="text" class="answer-input" 
                               data-task-id="{{ task.id }}" 
                               data-answer="1"
                               value="{{ answers.get(task.id, {}).get('answer_1', '') or '' }}"
                               placeholder="–û—Ç–≤–µ—Ç{% if task.answer_count == 2 %} 1{% endif %}"
                               oninput="scheduleSave({{ task.id }})">
                        {% if task.answer_count == 2 %}
                        <input type="text" class="answer-input" 
                               data-task-id="{{ task.id }}" 
                               data-answer="2"
                               value="{{ answers.get(task.id, {}).get('answer_2', '') or '' }}"
                               placeholder="–û—Ç–≤–µ—Ç 2"
                               oninput="scheduleSave({{ task.id }})">
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn secondary" onclick="goToTask({{ loop.index0 - 1 }})" {% if loop.first %}disabled{% endif %}>
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <button type="button" class="nav-btn save" id="saveBtn-{{ task.id }}" onclick="forceSave({{ task.id }})" disabled>
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button class="nav-btn primary" onclick="goToTask({{ loop.index0 + 1 }})" {% if loop.last %}disabled{% endif %}>
                        –î–∞–ª–µ–µ ‚Üí
                    </button>
                </div>
                <div class="save-status" id="saveStatus-{{ task.id }}">–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</div>
            </div>
            {% endfor %}
        </main>
    </div>
    
    <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()"></div>
    <div class="save-indicator" id="saveIndicator">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
    
    <script>
        let currentTask = {{ current_task }};
        let remainingSeconds = {{ remaining }};
        const teacherFinishOnly = {{ 'true' if teacher_finish_only else 'false' }};
        const appMode = {{ 'true' if app_mode else 'false' }};
        let isPaused = {{ 'true' if paused else 'false' }};
        const dirtyTasks = new Set();
        let zoomedImage = null;
        
        // –ó—É–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function toggleZoom(img) {
            const overlay = document.getElementById('zoomOverlay');
            if (img.classList.contains('zoomed')) {
                closeZoom();
            } else {
                img.classList.add('zoomed');
                overlay.classList.add('active');
                zoomedImage = img;
            }
        }
        
        function closeZoom() {
            const overlay = document.getElementById('zoomOverlay');
            if (zoomedImage) {
                zoomedImage.classList.remove('zoomed');
                zoomedImage = null;
            }
            overlay.classList.remove('active');
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeZoom();
        });

        function enterFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        }

        function updateFullscreenUI() {
            if (!appMode) return;
            const overlay = document.getElementById('fullscreenOverlay');
            const warning = document.getElementById('fullscreenWarning');
            if (!document.fullscreenElement) {
                if (overlay) overlay.classList.add('active');
                if (warning) warning.classList.add('active');
            } else {
                if (overlay) overlay.classList.remove('active');
                if (warning) warning.classList.remove('active');
            }
        }

        if (appMode) {
            updateFullscreenUI();
            document.addEventListener('fullscreenchange', updateFullscreenUI);
        }
        
        // –¢–∞–π–º–µ—Ä
        let timeOver = false;

        function lockInputs() {
            if (timeOver) return;
            timeOver = true;
            document.querySelectorAll('input.answer-input, textarea.answer-input').forEach(el => {
                el.disabled = true;
            });
            const note = document.createElement('div');
            note.className = 'time-over-note';
            note.textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—á–∏—Ç–µ–ª–µ–º.';
            document.querySelector('.content').prepend(note);
        }

        function updateTimer() {
            const mins = Math.floor(remainingSeconds / 60);
            const secs = remainingSeconds % 60;
            const timer = document.getElementById('timer');
            timer.textContent = mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
            
            if (remainingSeconds <= 300) timer.classList.add('warning');
            if (remainingSeconds <= 60) timer.classList.add('danger');
            
            if (remainingSeconds <= 0) {
                timer.textContent = '00:00';
                if (teacherFinishOnly) {
                    lockInputs();
                    return;
                }
                flushAll().then(() => {
                    document.getElementById('finishForm').submit();
                });
                return;
            }

            if (!isPaused) {
                remainingSeconds--;
            }
        }
        
        setPausedState(isPaused, remainingSeconds);
        updateTimer();
        setInterval(updateTimer, 1000);
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        async function goToTask(index) {
            if (index < 0 || index >= {{ tasks|length }}) return;

            const currentTaskId = getTaskIdByIndex(currentTask);
            if (currentTaskId && dirtyTasks.has(currentTaskId)) {
                await flushSave(currentTaskId);
            }

            document.querySelectorAll('.task-card').forEach(el => el.style.display = 'none');
            document.getElementById('task-' + index).style.display = 'block';

            document.querySelectorAll('.task-btn').forEach(el => el.classList.remove('current'));
            document.querySelector('.task-btn[data-task="' + index + '"]').classList.add('current');

            currentTask = index;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        const saveTimers = {};
        function scheduleSave(taskId) {
            markDirty(taskId);
            if (saveTimers[taskId]) clearTimeout(saveTimers[taskId]);
            saveTimers[taskId] = setTimeout(() => saveAnswer(taskId), 650);
        }

        function getTaskIdByIndex(index) {
            const card = document.getElementById('task-' + index);
            return card ? Number(card.dataset.taskId) : null;
        }

        function markDirty(taskId) {
            dirtyTasks.add(taskId);
            updateSaveButton(taskId);
            const btn = getTaskButtonByTaskId(taskId);
            if (btn) btn.classList.add('unsaved');
        }

        function updateSaveButton(taskId) {
            const btn = document.getElementById('saveBtn-' + taskId);
            const status = document.getElementById('saveStatus-' + taskId);
            const dirty = dirtyTasks.has(taskId);
            if (btn) btn.disabled = !dirty;
            if (status) status.textContent = dirty ? '–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
        }

        function getTaskButtonByTaskId(taskId) {
            const taskIndex = Array.from(document.querySelectorAll('.task-card')).findIndex(
                el => el.querySelector(`[data-task-id="${taskId}"]`)
            );
            if (taskIndex < 0) return null;
            return document.querySelector(`.task-btn[data-task="${taskIndex}"]`);
        }

        function isTaskAnswered(taskId) {
            const input1 = document.querySelector(`input[data-task-id="${taskId}"][data-answer="1"]`);
            const input2 = document.querySelector(`input[data-task-id="${taskId}"][data-answer="2"]`);
            const textarea = document.querySelector(`textarea[data-task-id="${taskId}"][data-answer="text"]`);
            if (textarea) return textarea.value.trim().length > 0;
            const v1 = input1 ? input1.value.trim() : '';
            const v2 = input2 ? input2.value.trim() : '';
            return v1.length > 0 || v2.length > 0;
        }

        function updateAnsweredState(taskId) {
            const taskIndex = Array.from(document.querySelectorAll('.task-card')).findIndex(
                el => el.querySelector(`[data-task-id="${taskId}"]`)
            );
            if (taskIndex < 0) return;
            const btn = document.querySelector(`.task-btn[data-task="${taskIndex}"]`);
            if (!btn) return;
            if (isTaskAnswered(taskId)) {
                btn.classList.add('answered');
            } else {
                btn.classList.remove('answered');
            }
            btn.classList.remove('unsaved');
        }

        async function flushSave(taskId) {
            if (saveTimers[taskId]) clearTimeout(saveTimers[taskId]);
            return saveAnswer(taskId);
        }

        async function flushAll() {
            const tasks = Array.from(dirtyTasks);
            if (tasks.length === 0) return;
            await Promise.all(tasks.map(taskId => saveAnswer(taskId)));
        }

        async function saveAnswer(taskId) {
            const input1 = document.querySelector(`input[data-task-id="${taskId}"][data-answer="1"]`);
            const input2 = document.querySelector(`input[data-task-id="${taskId}"][data-answer="2"]`);
            const textarea = document.querySelector(`textarea[data-task-id="${taskId}"][data-answer="text"]`);

            const data = {
                task_id: taskId,
                answer_1: input1 ? input1.value : null,
                answer_2: input2 ? input2.value : null,
                answer_text: textarea ? textarea.value : null
            };
            
            try {
                const response = await fetch('{{ url_for("student_save_answer") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const resp = await response.json().catch(() => ({}));
                    if (resp && resp.finished && resp.redirect) {
                        window.location.href = resp.redirect;
                        return;
                    }

                    dirtyTasks.delete(taskId);
                    updateSaveButton(taskId);
                    updateAnsweredState(taskId);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    const indicator = document.getElementById('saveIndicator');
                    indicator.classList.add('show');
                    setTimeout(() => indicator.classList.remove('show'), 1500);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        function forceSave(taskId) {
            return flushSave(taskId);
        }

        function setPausedState(paused, remaining) {
            isPaused = !!paused;
            if (typeof remaining === 'number') {
                remainingSeconds = remaining;
            }
            const overlay = document.getElementById('pauseOverlay');
            if (overlay) {
                overlay.classList.toggle('active', isPaused);
            }
            document.querySelectorAll('input.answer-input, textarea.answer-input').forEach(el => {
                el.readOnly = isPaused;
            });
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
        const finishForm = document.getElementById('finishForm');
        if (finishForm && !teacherFinishOnly) {
            finishForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await flushAll();
                finishForm.submit();
            });
        }
        
        async function heartbeat() {
            try {
                const res = await fetch('{{ url_for("student_ping") }}', { method: 'POST' });
                if (!res.ok) return;
                const data = await res.json().catch(() => null);
                if (data && data.redirect) {
                    await flushAll();
                    if (document.fullscreenElement) {
                        await document.exitFullscreen().catch(() => {});
                    }
                    window.location.href = data.redirect;
                    return;
                }
                if (data && Object.prototype.hasOwnProperty.call(data, 'paused')) {
                    setPausedState(data.paused, data.remaining_seconds);
                }
            } catch (e) {
                // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏
            }
        }

        heartbeat();
        setInterval(heartbeat, 5000);

        setInterval(() => {
            if (dirtyTasks.size > 0) {
                flushAll();
            }
        }, 15000);

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                flushAll();
            }
        });

        window.addEventListener('pagehide', () => {
            flushAll();
        });
    </script>
</body>
</html>
