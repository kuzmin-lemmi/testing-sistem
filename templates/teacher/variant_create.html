{% extends "teacher/base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç - –ï–ì–≠ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="variant-create-page">
    <div class="page-header">
        <h1>‚ûï –°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</h1>
        <a href="{{ url_for('variants_list') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
    
    <div class="create-steps">
        <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ -->
        <div class="step-card card" id="step1">
            <h2>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∞—Ä–∏–∞–Ω—Ç–∞</h2>
            <div class="type-options">
                <label class="type-option">
                    <input type="radio" name="variant_type" value="upload" onchange="updateType()">
                    <div class="type-content">
                        <div class="type-icon">üì§</div>
                        <div class="type-info">
                            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–¥–∞—á –∏ —Å–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</p>
                        </div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="variant_type" value="thematic" checked onchange="updateType()">
                    <div class="type-content">
                        <div class="type-icon">üìù</div>
                        <div class="type-info">
                            <h3>–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
                            <p>–ó–∞–¥–∞—á–∏ —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ï–ì–≠</p>
                        </div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="variant_type" value="mixed" onchange="updateType()">
                    <div class="type-content">
                        <div class="type-icon">üé®</div>
                        <div class="type-info">
                            <h3>–°–º–µ—à–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
                            <p>–ó–∞–¥–∞—á–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –ï–ì–≠</p>
                        </div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="variant_type" value="full" onchange="updateType()">
                    <div class="type-content">
                        <div class="type-icon">üéØ</div>
                        <div class="type-info">
                            <h3>–ü–æ–ª–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ï–ì–≠</h3>
                            <p>–ü–æ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ –∏–∑ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–º–µ—Ä–∞ (1-27)</p>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
        <div class="step-card card" id="uploadSettings" style="display: none;">
            <h2>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞</h2>
            <p class="hint-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–¥–∞–Ω–∏–π, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –ï–ì–≠ –∏ –æ—Ç–≤–µ—Ç—ã. –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±–∞–Ω–∫ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –≤–∞—Ä–∏–∞–Ω—Ç.</p>
            
            <form action="{{ url_for('variant_upload') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                <div class="form-group">
                    <label for="uploadName">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞</label>
                    <input type="text" name="name" id="uploadName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∞—Ä–∏–∞–Ω—Ç –°—Ç–∞—Ç–ì—Ä–∞–¥ –æ—Ç 20.01.2026" required>
                </div>
                
                <div class="dropzone-upload" id="dropzoneUpload">
                    <div class="dropzone-content">
                        <span class="dropzone-icon">üìÅ</span>
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PNG-—Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
                        <p class="dropzone-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)</p>
                    </div>
                    <input type="file" name="images" id="imagesInput" accept=".png,.jpg,.jpeg" multiple>
                </div>
                
                <div id="tasksTable" style="display: none;">
                    <h3>üìã –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è (<span id="tasksCount">0</span>)</h3>
                    <div class="tasks-edit-list" id="tasksList">
                        <!-- –ó–∞–¥–∞—á–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>
                
                <div class="form-actions" id="uploadActions" style="display: none;">
                    <button type="submit" class="btn btn-primary btn-large">
                        ‚ú® –°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–Ω–∫
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearUpload()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </form>
        </div>
        
        <!-- –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="step-card card" id="step2">
            <h2>2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞</h2>
            
            <form action="{{ url_for('variant_create') }}" method="POST" id="variantForm" novalidate>
                <input type="hidden" name="variant_type" id="hiddenType" value="thematic">
                
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞</label>
                    <input type="text" name="name" id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Ññ1 –∏–ª–∏ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è 10–ê" required>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
                <div id="thematicSettings">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ege_number">–ù–æ–º–µ—Ä –ï–ì–≠</label>
                            <select name="ege_number" id="ege_number" onchange="updateTasksList()">
                                {% for num in range(1, 28) %}
                                <option value="{{ num }}" data-count="{{ task_counts.get(num, 0) }}">
                                    ‚Ññ{{ num }} ({{ task_counts.get(num, 0) }} –∑–∞–¥–∞—á)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tasks_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</label>
                            <input type="number" name="tasks_count" id="tasks_count" value="10" min="1" max="50">
                        </div>
                    </div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
                <div id="mixedSettings" style="display: none;">
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –ï–ì–≠ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –∏–∑ –∫–∞–∂–¥–æ–≥–æ</label>
                        <p class="hint-text">–û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∏ —É–∫–∞–∂–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –≤–∑—è—Ç—å –∏–∑ –∫–∞–∂–¥–æ–≥–æ</p>
                        <div class="mixed-selection">
                            {% for num in range(1, 28) %}
                            <div class="mixed-row">
                                <label class="mixed-checkbox">
                                    <input type="checkbox" name="mixed_ege_{{ num }}" value="{{ num }}" onchange="updateMixedTotal()">
                                    <span class="ege-num">‚Ññ{{ num }}</span>
                                </label>
                                <input type="number" name="mixed_count_{{ num }}" value="1" min="1" max="{{ task_counts.get(num, 0) }}" class="mixed-count" onchange="updateMixedTotal()">
                                <span class="available-info">({{ task_counts.get(num, 0) }} –¥–æ—Å—Ç—É–ø–Ω–æ)</span>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mixed-total">
                            –í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ: <span id="mixedTotalCount">0</span>
                        </div>
                        <div class="mixed-presets">
                            <span>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</span>
                            <button type="button" class="btn btn-small btn-outline" onclick="selectMixedPreset([1,2,3,4,5,6,7,8])">‚Ññ1-8</button>
                            <button type="button" class="btn btn-small btn-outline" onclick="selectMixedPreset([1,3,5,7,12,14,16])">–õ—ë–≥–∫–∏–µ</button>
                            <button type="button" class="btn btn-small btn-outline" onclick="selectMixedPreset([17,18,19,20,21,22,23,24,25,26,27])">‚Ññ17-27</button>
                            <button type="button" class="btn btn-small btn-outline" onclick="clearMixedSelection()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
                
                <!-- –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                <div class="form-group">
                    <label>–°–ø–æ—Å–æ–± –≤—ã–±–æ—Ä–∞ –∑–∞–¥–∞—á</label>
                    <div class="mode-options">
                        <label class="mode-option">
                            <input type="radio" name="generation_mode" value="random" checked onchange="updateMode()">
                            <span class="mode-label">üé≤ –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä</span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="generation_mode" value="manual" onchange="updateMode()">
                            <span class="mode-label">‚úã –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä</span>
                        </label>
                    </div>
                </div>
                
                <!-- –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –∑–∞–¥–∞—á (—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π) -->
                <div id="manualThematicSelection" style="display: none;">
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏</label>
                        <div class="tasks-selection" id="tasksSelection">
                            <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </div>
                    </div>
                </div>
                
                <!-- –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –∑–∞–¥–∞—á (–ø–æ–ª–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) -->
                <div id="manualFullSelection" style="display: none;">
                    <div class="form-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–º–µ—Ä–∞</label>
                        <div class="full-variant-selection">
                            {% for ege_num in range(1, 28) %}
                            <div class="ege-row">
                                <span class="ege-label">‚Ññ{{ ege_num }}</span>
                                <select name="task_ege_{{ ege_num }}" class="task-select">
                                    <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                                    {% for task in all_tasks.get(ege_num, []) %}
                                    <option value="{{ task.id }}">#{{ task.id }} (–æ—Ç–≤–µ—Ç: {{ task.answer_1 }}{% if task.answer_2 %}, {{ task.answer_2 }}{% endif %})</option>
                                    {% endfor %}
                                </select>
                                <span class="available-count">{{ all_tasks.get(ege_num, [])|length }} –¥–æ—Å—Ç—É–ø–Ω–æ</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-error" id="variantFormError" style="display: none;"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">‚ú® –°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
                    <a href="{{ url_for('variants_list') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.create-steps {
    max-width: 800px;
}

.step-card {
    margin-bottom: 24px;
}

.step-card h2 {
    margin-bottom: 24px;
    font-size: 1.3em;
}

.form-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
    padding: 12px 16px;
    border-radius: var(--radius);
    margin-bottom: 12px;
    font-weight: 600;
}

.type-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
}

.hint-text {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 16px;
}

.mixed-selection {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-sidebar);
    border-radius: var(--radius);
    margin-bottom: 16px;
}

.mixed-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
}

.mixed-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
}

.mixed-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.ege-num {
    font-weight: 600;
    color: var(--primary);
    min-width: 35px;
}

.mixed-count {
    width: 50px;
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    text-align: center;
}

.available-info {
    font-size: 11px;
    color: var(--text-muted);
}

.mixed-total {
    font-size: 1.1em;
    font-weight: 600;
    padding: 12px 16px;
    background: var(--primary-bg);
    border-radius: var(--radius);
    margin-bottom: 16px;
}

.mixed-total span {
    color: var(--primary);
    font-size: 1.3em;
}

.mixed-presets {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.mixed-presets span {
    color: var(--text-secondary);
    font-size: 14px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ */
.dropzone-upload {
    border: 3px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 40px 30px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    margin-bottom: 24px;
}

.dropzone-upload:hover, .dropzone-upload.dragover {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.dropzone-upload input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.dropzone-icon {
    font-size: 3em;
    display: block;
    margin-bottom: 12px;
}

.dropzone-hint {
    color: var(--text-muted);
    font-size: 14px;
}

.tasks-edit-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 16px;
    margin-bottom: 24px;
}

.task-edit-item {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 16px;
    padding: 16px;
    background: var(--bg-sidebar);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
}

.task-edit-preview {
    width: 120px;
    height: 90px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.task-edit-fields {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.task-edit-row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.task-edit-row label {
    font-size: 13px;
    color: var(--text-secondary);
    min-width: 80px;
}

.task-edit-row select,
.task-edit-row input[type="number"],
.task-edit-row input[type="text"] {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: inherit;
}

.task-edit-row select {
    min-width: 100px;
}

.task-edit-row input[type="number"] {
    width: 100px;
}

.task-edit-row input[type="file"] {
    font-size: 13px;
}

.task-order {
    font-weight: 700;
    color: var(--primary);
    font-size: 1.2em;
    min-width: 30px;
}

.btn-remove-task {
    background: var(--danger-bg);
    color: var(--danger);
    border: none;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 13px;
    margin-left: auto;
}

.btn-remove-task:hover {
    background: var(--danger);
    color: white;
}

.btn-large {
    padding: 16px 32px;
    font-size: 16px;
}

.type-option {
    cursor: pointer;
}

.type-option input {
    display: none;
}

.type-content {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    transition: var(--transition);
}

.type-option input:checked + .type-content {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.type-icon {
    font-size: 2.5em;
}

.type-info h3 {
    margin-bottom: 4px;
    color: var(--text);
}

.type-info p {
    color: var(--text-secondary);
    font-size: 14px;
}

.mode-options {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.mode-option {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.mode-label {
    padding: 10px 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    transition: var(--transition);
}

.mode-option input:checked + .mode-label {
    border-color: var(--primary);
    background: var(--primary-bg);
    color: var(--primary-dark);
}

.mode-option input {
    display: none;
}

.tasks-selection {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 700px;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-sidebar);
    border-radius: var(--radius);
}

.task-checkbox {
    cursor: pointer;
    display: block;
    position: relative;
}

.task-checkbox input {
    position: absolute;
    top: 56px;
    left: 18px;
    width: 22px;
    height: 22px;
    z-index: 2;
    accent-color: var(--primary);
}

.task-preview {
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: white;
    overflow: hidden;
    transition: var(--transition);
}

.task-checkbox input:checked + .task-preview {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-bg);
}

.task-preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 14px;
    background: var(--bg-sidebar);
    border-bottom: 1px solid var(--border-light);
    font-size: 13px;
    color: var(--text-secondary);
    min-height: 40px;
}

.task-preview-title {
    font-weight: 700;
    color: var(--text);
}

.task-preview-image {
    padding: 12px;
    background: white;
}

.task-preview img {
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: contain;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.full-variant-selection {
    max-height: 500px;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-sidebar);
    border-radius: var(--radius);
}

.ege-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.ege-row:last-child {
    border-bottom: none;
}

.ege-label {
    font-weight: 700;
    width: 50px;
    color: var(--primary);
}

.task-select {
    flex: 1;
    padding: 10px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-family: inherit;
}

.available-count {
    font-size: 12px;
    color: var(--text-muted);
    width: 100px;
    text-align: right;
}
</style>

<script>
const allTasks = {{ all_tasks | tojson }};
const taskCounts = {{ task_counts | tojson }};
const defaultAnswerCount = {{ default_answer_count | tojson if default_answer_count else '{}' }};

// –§–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
let uploadedFiles = [];

function updateType() {
    const type = document.querySelector('input[name="variant_type"]:checked').value;
    document.getElementById('hiddenType').value = type;
    
    const uploadSettings = document.getElementById('uploadSettings');
    const step2 = document.getElementById('step2');
    const thematicSettings = document.getElementById('thematicSettings');
    const mixedSettings = document.getElementById('mixedSettings');
    const manualFull = document.getElementById('manualFullSelection');
    const manualThematic = document.getElementById('manualThematicSelection');
    const modeOptions = document.querySelector('.mode-options')?.parentElement;
    
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ
    uploadSettings.style.display = 'none';
    step2.style.display = 'block';
    thematicSettings.style.display = 'none';
    mixedSettings.style.display = 'none';
    manualFull.style.display = 'none';
    manualThematic.style.display = 'none';
    if (modeOptions) modeOptions.style.display = 'block';
    
    if (type === 'upload') {
        uploadSettings.style.display = 'block';
        step2.style.display = 'none';
    } else if (type === 'thematic') {
        thematicSettings.style.display = 'block';
        updateMode();
    } else if (type === 'mixed') {
        mixedSettings.style.display = 'block';
        if (modeOptions) modeOptions.style.display = 'none';
    } else {
        updateMode();
    }
}


function updateMode() {
    const type = document.querySelector('input[name="variant_type"]:checked').value;
    const mode = document.querySelector('input[name="generation_mode"]:checked').value;
    
    const manualThematic = document.getElementById('manualThematicSelection');
    const manualFull = document.getElementById('manualFullSelection');
    
    if (mode === 'manual') {
        if (type === 'thematic') {
            manualThematic.style.display = 'block';
            manualFull.style.display = 'none';
            updateTasksList();
        } else if (type === 'full') {
            manualThematic.style.display = 'none';
            manualFull.style.display = 'block';
        }
    } else {
        manualThematic.style.display = 'none';
        manualFull.style.display = 'none';
    }
}

function updateTasksList() {
    const egeNumber = document.getElementById('ege_number').value;
    const tasks = allTasks[egeNumber] || [];
    const container = document.getElementById('tasksSelection');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1;">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è —ç—Ç–æ–≥–æ –Ω–æ–º–µ—Ä–∞</p>';
        return;
    }
    
    container.innerHTML = tasks.map(task => `
        <label class="task-checkbox">
            <input type="checkbox" name="selected_tasks" value="${task.id}">
            <div class="task-preview">
                <div class="task-preview-header">
                    <span class="task-preview-title">–ó–∞–¥–∞—á–∞ #${task.id}</span>
                    <span>‚Ññ${task.ege_number} –ï–ì–≠</span>
                </div>
                <div class="task-preview-image">
                    <img src="/images/${task.image_path}" alt="–ó–∞–¥–∞—á–∞ ${task.id}">
                </div>
            </div>
        </label>
    `).join('');
}

function updateMixedTotal() {
    let total = 0;
    for (let i = 1; i <= 27; i++) {
        const checkbox = document.querySelector(`input[name="mixed_ege_${i}"]`);
        const countInput = document.querySelector(`input[name="mixed_count_${i}"]`);
        if (checkbox && checkbox.checked && countInput) {
            total += parseInt(countInput.value) || 0;
        }
    }
    document.getElementById('mixedTotalCount').textContent = total;
}

function selectMixedPreset(numbers) {
    // –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∞–µ–º –≤—Å–µ –≥–∞–ª–æ—á–∫–∏
    for (let i = 1; i <= 27; i++) {
        const checkbox = document.querySelector(`input[name="mixed_ege_${i}"]`);
        if (checkbox) checkbox.checked = false;
    }
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ
    numbers.forEach(num => {
        const checkbox = document.querySelector(`input[name="mixed_ege_${num}"]`);
        if (checkbox) checkbox.checked = true;
    });
    updateMixedTotal();
}

function clearMixedSelection() {
    for (let i = 1; i <= 27; i++) {
        const checkbox = document.querySelector(`input[name="mixed_ege_${i}"]`);
        if (checkbox) checkbox.checked = false;
    }
    updateMixedTotal();
}

// ========== –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ ==========

const dropzoneUpload = document.getElementById('dropzoneUpload');
const imagesInput = document.getElementById('imagesInput');
const tasksList = document.getElementById('tasksList');
const tasksTable = document.getElementById('tasksTable');
const tasksCount = document.getElementById('tasksCount');
const uploadActions = document.getElementById('uploadActions');

// Drag & drop
if (dropzoneUpload) {
    dropzoneUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzoneUpload.classList.add('dragover');
    });

    dropzoneUpload.addEventListener('dragleave', () => {
        dropzoneUpload.classList.remove('dragover');
    });

    dropzoneUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzoneUpload.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    imagesInput.addEventListener('change', () => {
        handleFiles(imagesInput.files);
    });
}

function handleFiles(files) {
    const newFiles = Array.from(files).filter(f => 
        f.type.startsWith('image/') || f.name.endsWith('.png') || f.name.endsWith('.jpg') || f.name.endsWith('.jpeg')
    );
    
    newFiles.forEach(file => {
        uploadedFiles.push(file);
        addTaskRow(file, uploadedFiles.length - 1);
    });
    
    updateTasksDisplay();
}

function addTaskRow(file, index) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const row = document.createElement('div');
        row.className = 'task-edit-item';
        row.id = `task-row-${index}`;
        row.innerHTML = `
            <img src="${e.target.result}" class="task-edit-preview" alt="–ó–∞–¥–∞—á–∞">
            <div class="task-edit-fields">
                <div class="task-edit-row">
                    <span class="task-order">#${index + 1}</span>
                    <label>–ù–æ–º–µ—Ä –ï–ì–≠:</label>
                    <select name="ege_number_${index}" required onchange="updateAnswerFields(${index})">
                        ${generateEgeOptions()}
                    </select>
                    <button type="button" class="btn-remove-task" onclick="removeTask(${index})">‚úï –£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <div class="task-edit-row">
                    <label>–û—Ç–≤–µ—Ç 1:</label>
                    <input type="text" name="answer1_${index}" required autocomplete="off">
                    <span id="answer2-wrapper-${index}">
                        <label>–û—Ç–≤–µ—Ç 2:</label>
                        <input type="text" name="answer2_${index}" autocomplete="off">
                    </span>
                </div>
                <div class="task-edit-row">
                    <label>–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö:</label>
                    <input type="file" name="attachment_${index}" accept=".txt,.xlsx,.csv">
                    <span class="hint" style="font-size:12px;color:var(--text-muted);">(–¥–ª—è ‚Ññ9, ‚Ññ18, ‚Ññ26, ‚Ññ27)</span>
                </div>
            </div>
        `;
        tasksList.appendChild(row);
        updateAnswerFields(index);
    };
    reader.readAsDataURL(file);
}

function generateEgeOptions() {
    let options = '';
    for (let i = 1; i <= 27; i++) {
        options += `<option value="${i}">‚Ññ${i}</option>`;
    }
    return options;
}

function updateAnswerFields(index) {
    const select = document.querySelector(`select[name="ege_number_${index}"]`);
    const wrapper = document.getElementById(`answer2-wrapper-${index}`);
    if (select && wrapper) {
        const egeNum = parseInt(select.value);
        // –ù–æ–º–µ—Ä–∞ 17-25 —Ç—Ä–µ–±—É—é—Ç –¥–≤–∞ –æ—Ç–≤–µ—Ç–∞
        if (egeNum >= 17 && egeNum <= 25) {
            wrapper.style.display = 'inline';
        } else {
            wrapper.style.display = 'none';
        }
    }
}

function removeTask(index) {
    uploadedFiles[index] = null;
    const row = document.getElementById(`task-row-${index}`);
    if (row) row.remove();
    updateTasksDisplay();
    renumberTasks();
}

function renumberTasks() {
    const rows = tasksList.querySelectorAll('.task-edit-item');
    rows.forEach((row, i) => {
        const orderSpan = row.querySelector('.task-order');
        if (orderSpan) orderSpan.textContent = `#${i + 1}`;
    });
}

function updateTasksDisplay() {
    const activeCount = uploadedFiles.filter(f => f !== null).length;
    tasksCount.textContent = activeCount;
    
    if (activeCount > 0) {
        tasksTable.style.display = 'block';
        uploadActions.style.display = 'flex';
    } else {
        tasksTable.style.display = 'none';
        uploadActions.style.display = 'none';
    }
}

function clearUpload() {
    uploadedFiles = [];
    tasksList.innerHTML = '';
    imagesInput.value = '';
    updateTasksDisplay();
}

// –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã - –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
if (document.getElementById('uploadForm')) {
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        // –°–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç—ã–µ input –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const dataTransfer = new DataTransfer();
        uploadedFiles.forEach((file, index) => {
            if (file) {
                dataTransfer.items.add(file);
            }
        });
        imagesInput.files = dataTransfer.files;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ä—è–¥–∫–µ —Ñ–∞–π–ª–æ–≤
        const orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = 'files_order';
        orderInput.value = JSON.stringify(uploadedFiles.map((f, i) => f ? i : null).filter(x => x !== null));
        this.appendChild(orderInput);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    updateType();
    updateTasksList();
});

const variantForm = document.getElementById('variantForm');
if (variantForm) {
    variantForm.addEventListener('submit', function(e) {
        const errors = [];
        const nameInput = document.getElementById('name');
        if (!nameInput || !nameInput.value.trim()) {
            errors.push('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞.');
        }

        const type = document.querySelector('input[name="variant_type"]:checked')?.value;
        const mode = document.querySelector('input[name="generation_mode"]:checked')?.value;
        if (type === 'thematic' && mode === 'manual') {
            const selectedCount = document.querySelectorAll('input[name="selected_tasks"]:checked').length;
            if (selectedCount === 0) {
                errors.push('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–¥–∞—á—É –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞.');
            }
        }

        if (errors.length > 0) {
            e.preventDefault();
            const errorBox = document.getElementById('variantFormError');
            if (errorBox) {
                errorBox.textContent = errors[0];
                errorBox.style.display = 'block';
                errorBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            if (nameInput && !nameInput.value.trim()) {
                nameInput.focus();
            }
        }
    });
}
</script>
{% endblock %}
