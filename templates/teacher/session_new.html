{% extends "teacher/base.html" %}

{% block title %}–ù–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ï–ì–≠ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="session-new-page">
    <div class="page-header">
        <h1>‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <a href="{{ url_for('sessions_list') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
    
    <form action="{{ url_for('session_new') }}" method="POST" class="session-form">
        <!-- –®–∞–≥ 1: –†–µ–∂–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
        <div class="step-card card">
            <h2>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–∑–¥–∞—á–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</h2>
            <div class="mode-options">
                <label class="mode-option">
                    <input type="radio" name="variant_mode" value="single" checked onchange="updateMode()">
                    <div class="mode-content">
                        <div class="mode-icon">üìã</div>
                        <div class="mode-info">
                            <h3>–û–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤—Å–µ—Ö</h3>
                            <p>–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —Ä–µ—à–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</p>
                        </div>
                    </div>
                </label>
                <label class="mode-option">
                    <input type="radio" name="variant_mode" value="individual" onchange="updateMode()">
                    <div class="mode-content">
                        <div class="mode-icon">üé≤</div>
                        <div class="mode-info">
                            <h3>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h3>
                            <p>–ö–∞–∂–¥–æ–º—É —É—á–µ–Ω–∏–∫—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–≤–æ–π –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á</p>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
        <div class="step-card card" id="singleSettings">
            <h2>2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</h2>
            {% if variants %}
            <div class="variants-select">
                {% for variant in variants %}
                <label class="variant-option">
                    <input type="radio" name="variant_id" value="{{ variant.id }}" data-tasks-count="{{ variant.tasks_count }}"
                           {% if variant.id == preselected_variant or (loop.first and not preselected_variant) %}checked{% endif %}>
                    <div class="variant-content">
                        <span class="variant-type">
                            {% if variant.variant_type == 'full' %}üéØ{% else %}üìù{% endif %}
                        </span>
                        <span class="variant-name">{{ variant.name }}</span>
                        <span class="variant-count">{{ variant.tasks_count }} –∑–∞–¥–∞—á</span>
                    </div>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-variants">
                <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>
                <a href="{{ url_for('variant_create') }}" class="btn btn-secondary">–°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</a>
            </div>
            {% endif %}
        </div>
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
        <div class="step-card card" id="individualSettings" style="display: none;">
            <h2>2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h2>
            <div class="form-group">
                <label>–¢–∏–ø –≤–∞—Ä–∏–∞–Ω—Ç–∞</label>
                <div class="type-options">
                    <label class="type-option-small">
                        <input type="radio" name="individual_type" value="full" checked>
                        <span>üéØ –ü–æ–ª–Ω—ã–π –ï–ì–≠ (27 –∑–∞–¥–∞—á)</span>
                    </label>
                    <label class="type-option-small">
                        <input type="radio" name="individual_type" value="thematic" onchange="toggleThematic()">
                        <span>üìù –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π</span>
                    </label>
                </div>
            </div>
            <div id="thematicOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –ï–ì–≠</label>
                        <select name="individual_ege">
                            {% for num in range(1, 28) %}
                            <option value="{{ num }}">‚Ññ{{ num }} ({{ task_counts.get(num, 0) }} –∑–∞–¥–∞—á)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</label>
                        <input type="number" name="individual_count" value="10" min="1" max="50">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –®–∞–≥ 3: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
        <div class="step-card card">
            <h2>3Ô∏è‚É£ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>‚è± –í—Ä–µ–º—è –Ω–∞ —Ç–µ—Å—Ç (–º–∏–Ω—É—Ç)</label>
                    <input type="number" name="time_limit" value="60" min="5" max="240">
                </div>
                <div class="form-group">
                    <label>üîë –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</label>
                    <div class="checkbox-toggle">
                        <label>
                            <input type="checkbox" name="use_code" value="1" checked>
                            <span>–¢—Ä–µ–±–æ–≤–∞—Ç—å –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>üìä –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</label>
                <div class="checkbox-toggle">
                    <label>
                        <input type="checkbox" name="show_answers" value="1" checked>
                        <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —É—á–µ–Ω–∏–∫–∞–º</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>üßë‚Äçüè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º</label>
                <div class="checkbox-toggle">
                    <label>
                        <input type="checkbox" name="teacher_finish_only" value="1">
                        <span>–ó–∞–≤–µ—Ä—à–∞—Ç—å —Ç–µ—Å—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–º–∞–Ω–¥–µ —É—á–∏—Ç–µ–ª—è</span>
                    </label>
                </div>
                <p class="hint">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî —É—á–µ–Ω–∏–∫–∏ –Ω–µ —Å–º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç —Å–∞–º–∏.</p>
            </div>
            <div class="form-group">
                <label>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</label>
                <div class="checkbox-toggle">
                    <label>
                        <input type="checkbox" name="calculator_enabled" value="1">
                        <span>–†–∞–∑—Ä–µ—à–∏—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —É—á–µ–Ω–∏–∫–∞–º</span>
                    </label>
                </div>
                <p class="hint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å –¥—Ä–æ–±—è–º–∏, —Å—Ç–µ–ø–µ–Ω—è–º–∏ –∏ –∫–æ—Ä–Ω—è–º–∏.</p>
            </div>
        </div>
        
        <!-- –®–∞–≥ 4: –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ -->
        <div class="step-card card">
            <h2>4Ô∏è‚É£ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <p class="hint-text">–£–∫–∞–∂–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ü–µ–Ω–∫–∏</p>
            
            {% if saved_criteria %}
            <div class="form-group">
                <label>üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏</label>
                <select id="savedCriteria" onchange="loadSavedCriteria()">
                    <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ (–≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é) ‚Äî</option>
                    {% for crit in saved_criteria %}
                    <option value="{{ crit.total_tasks }}_{{ crit.grade_5_min }}_{{ crit.grade_4_min }}_{{ crit.grade_3_min }}" 
                            data-total="{{ crit.total_tasks }}"
                            data-g5="{{ crit.grade_5_min }}"
                            data-g4="{{ crit.grade_4_min }}"
                            data-g3="{{ crit.grade_3_min }}">
                        {{ crit.name }} ({{ crit.total_tasks }} –∑–∞–¥–∞—á: 5‚â•{{ crit.grade_5_min }}, 4‚â•{{ crit.grade_4_min }}, 3‚â•{{ crit.grade_3_min }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label>üìù –í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ</label>
                <input type="number" name="total_tasks" id="totalTasks" value="8" min="1" max="100" onchange="updateGradeHints()">
            </div>
            </div>
            
            <div class="grades-row">
                <div class="grade-input">
                    <label class="grade-label grade-5-label">–ú–∏–Ω–∏–º—É–º –Ω–∞ 5</label>
                    <input type="number" name="grade_5_min" id="grade5" value="7" min="1">
                    <span class="grade-hint" id="hint5"></span>
                </div>
                <div class="grade-input">
                    <label class="grade-label grade-4-label">–ú–∏–Ω–∏–º—É–º –Ω–∞ 4</label>
                    <input type="number" name="grade_4_min" id="grade4" value="5" min="1">
                    <span class="grade-hint" id="hint4"></span>
                </div>
                <div class="grade-input">
                    <label class="grade-label grade-3-label">–ú–∏–Ω–∏–º—É–º –Ω–∞ 3</label>
                    <input type="number" name="grade_3_min" id="grade3" value="3" min="1">
                    <span class="grade-hint" id="hint3"></span>
                </div>
            </div>
            
            <div class="grade-presets">
                <span class="presets-label">–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:</span>
                <button type="button" class="btn btn-small btn-outline" onclick="setPreset(27)">–ï–ì–≠ (27)</button>
                <button type="button" class="btn btn-small btn-outline" onclick="setPreset(10)">10 –∑–∞–¥–∞—á</button>
                <button type="button" class="btn btn-small btn-outline" onclick="setPreset(8)">8 –∑–∞–¥–∞—á</button>
                <button type="button" class="btn btn-small btn-outline" onclick="setPreset(5)">5 –∑–∞–¥–∞—á</button>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-success btn-large">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        </div>
    </form>
</div>

<style>
.session-form {
    max-width: 700px;
}

.step-card {
    margin-bottom: 20px;
}

.step-card h2 {
    margin-bottom: 20px;
}

.mode-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
}

.mode-option {
    cursor: pointer;
}

.mode-option input {
    display: none;
}

.mode-content {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    transition: var(--transition);
}

.mode-option input:checked + .mode-content {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.mode-icon {
    font-size: 2em;
}

.mode-info h3 {
    margin-bottom: 4px;
}

.mode-info p {
    color: var(--text-secondary);
    font-size: 14px;
}

.variants-select {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.variant-option {
    cursor: pointer;
}

.variant-option input {
    display: none;
}

.variant-content {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    transition: var(--transition);
}

.variant-count {
    margin-left: auto;
    font-size: 13px;
    color: var(--text-secondary);
}

.variant-option input:checked + .variant-content {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.variant-type {
    font-size: 1.3em;
}

.no-variants {
    text-align: center;
    padding: 30px;
    color: var(--text-secondary);
}

.type-options {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.type-option-small {
    cursor: pointer;
    display: flex;
    align-items: center;
}

.type-option-small input {
    display: none;
}

.type-option-small span {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    transition: var(--transition);
}

.type-option-small input:checked + span {
    border-color: var(--primary);
    background: var(--primary-bg);
}

.checkbox-toggle label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-toggle input {
    width: 20px;
    height: 20px;
}

.btn-large {
    padding: 16px 32px;
    font-size: 16px;
}

.hint-text {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 20px;
}

.grades-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.grade-input {
    text-align: center;
}

.grade-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    padding: 6px 12px;
    border-radius: var(--radius);
}

.grade-5-label { background: #d1fae5; color: #065f46; }
.grade-4-label { background: #dbeafe; color: #1e40af; }
.grade-3-label { background: #fef3c7; color: #92400e; }

.grade-input input {
    width: 80px;
    text-align: center;
    font-size: 1.3em;
    font-weight: 600;
    padding: 12px;
}

.grade-hint {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.grade-presets {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
}

.presets-label {
    color: var(--text-secondary);
    font-size: 14px;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--border);
    color: var(--text);
}

.btn-outline:hover {
    background: var(--bg-sidebar);
    border-color: var(--primary);
}
</style>

<script>
function updateMode() {
    const mode = document.querySelector('input[name="variant_mode"]:checked').value;
    document.getElementById('singleSettings').style.display = mode === 'single' ? 'block' : 'none';
    document.getElementById('individualSettings').style.display = mode === 'individual' ? 'block' : 'none';
    syncTotalTasks();
}

function toggleThematic() {
    const type = document.querySelector('input[name="individual_type"]:checked').value;
    document.getElementById('thematicOptions').style.display = type === 'thematic' ? 'block' : 'none';
    syncTotalTasks();
}

document.querySelectorAll('input[name="individual_type"]').forEach(input => {
    input.addEventListener('change', toggleThematic);
});

document.querySelectorAll('input[name="variant_id"]').forEach(input => {
    input.addEventListener('change', syncTotalTasks);
});

const individualCountInput = document.querySelector('input[name="individual_count"]');
if (individualCountInput) {
    individualCountInput.addEventListener('input', syncTotalTasks);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –æ—Ü–µ–Ω–∫–∏
function updateGradeHints() {
    const total = parseInt(document.getElementById('totalTasks').value) || 1;
    const g5 = parseInt(document.getElementById('grade5').value) || 0;
    const g4 = parseInt(document.getElementById('grade4').value) || 0;
    const g3 = parseInt(document.getElementById('grade3').value) || 0;
    
    document.getElementById('hint5').textContent = `‚â•${Math.round(g5/total*100)}%`;
    document.getElementById('hint4').textContent = `‚â•${Math.round(g4/total*100)}%`;
    document.getElementById('hint3').textContent = `‚â•${Math.round(g3/total*100)}%`;
}

function syncTotalTasks() {
    const totalInput = document.getElementById('totalTasks');
    if (!totalInput) return;
    const modeInput = document.querySelector('input[name="variant_mode"]:checked');
    if (!modeInput) return;
    const mode = modeInput.value;
    if (mode === 'single') {
        const selected = document.querySelector('input[name="variant_id"]:checked');
        if (selected && selected.dataset.tasksCount) {
            totalInput.value = selected.dataset.tasksCount;
            updateGradeHints();
        }
        return;
    }
    const type = document.querySelector('input[name="individual_type"]:checked')?.value;
    if (type === 'full') {
        totalInput.value = 27;
        updateGradeHints();
        return;
    }
    if (type === 'thematic') {
        const countInput = document.querySelector('input[name="individual_count"]');
        if (countInput && countInput.value) {
            totalInput.value = countInput.value;
            updateGradeHints();
        }
    }
}

function setPreset(total) {
    document.getElementById('totalTasks').value = total;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Ä–æ–≥–∏: 5=85%, 4=65%, 3=45%
    document.getElementById('grade5').value = Math.ceil(total * 0.85);
    document.getElementById('grade4').value = Math.ceil(total * 0.65);
    document.getElementById('grade3').value = Math.ceil(total * 0.45);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
    const savedSelect = document.getElementById('savedCriteria');
    if (savedSelect) savedSelect.value = '';
    
    updateGradeHints();
}

function loadSavedCriteria() {
    const select = document.getElementById('savedCriteria');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        document.getElementById('totalTasks').value = option.dataset.total;
        document.getElementById('grade5').value = option.dataset.g5;
        document.getElementById('grade4').value = option.dataset.g4;
        document.getElementById('grade3').value = option.dataset.g3;
        updateGradeHints();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
updateMode();
syncTotalTasks();
updateGradeHints();
</script>
{% endblock %}
