{% extends "teacher/base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É #{{ task.id }} - –ï–ì–≠ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="task-form-page">
    <div class="page-header">
        <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É #{{ task.id }}</h1>
        <a href="{{ url_for('tasks_list', ege=task.ege_number) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
    
    <form action="{{ url_for('task_edit', task_id=task.id) }}" method="POST" enctype="multipart/form-data" class="task-form card">
        <div class="form-group">
            <label for="ege_number">–ù–æ–º–µ—Ä –ï–ì–≠</label>
            <select name="ege_number" id="ege_number" required>
                {% for num in range(1, 28) %}
                <option value="{{ num }}" {% if num == task.ege_number %}selected{% endif %}>
                    –ó–∞–¥–∞–Ω–∏–µ ‚Ññ{{ num }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            <div class="current-image">
                <img src="{{ url_for('serve_image', filename=task.image_path) }}" alt="–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
            </div>
        </div>
        
        <div class="form-group">
            <label for="image">–ó–∞–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="file" name="image" id="image" accept=".png">
            <div class="file-preview" id="imagePreview"></div>
        </div>
        
        <div class="form-group">
            <label>–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª</label>
            {% if task.attachment_path %}
            <div class="current-attachment">
                <span>üìé {{ task.attachment_name }}</span>
                <a href="{{ url_for('serve_attachment', filename=task.attachment_path) }}" download class="btn btn-small">–°–∫–∞—á–∞—Ç—å</a>
                <label class="checkbox-label">
                    <input type="checkbox" name="remove_attachment" value="1"> –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
                </label>
            </div>
            {% else %}
            <p class="no-attachment">–§–∞–π–ª –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω</p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="attachment">{% if task.attachment_path %}–ó–∞–º–µ–Ω–∏—Ç—å{% else %}–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å{% endif %} —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</label>
            <input type="file" name="attachment" id="attachment" accept=".txt,.xlsx,.csv">
            <small class="form-hint">TXT, XLSX, CSV (–¥–æ 10 –ú–ë)</small>
        </div>
        
        <div class="form-group">
            <label for="answer_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤</label>
            <select name="answer_count" id="answer_count" onchange="toggleSecondAnswer()">
                <option value="0" {% if task.answer_count == 0 %}selected{% endif %}>–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</option>
                <option value="1" {% if task.answer_count == 1 %}selected{% endif %}>1 –æ—Ç–≤–µ—Ç</option>
                <option value="2" {% if task.answer_count == 2 %}selected{% endif %}>2 –æ—Ç–≤–µ—Ç–∞</option>
            </select>
        </div>

        <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (1-2) -->
        <div id="standardAnswers" {% if task.answer_count == 0 %}style="display:none"{% endif %}>
            <div class="form-row">
                <div class="form-group">
                    <label for="answer_1">–û—Ç–≤–µ—Ç 1</label>
                    <input type="text" name="answer_1" id="answer_1" value="{{ task.answer_1 }}" autocomplete="off">
                </div>
                
                <div class="form-group" id="answer2Group" {% if task.answer_count != 2 %}style="display: none;"{% endif %}>
                    <label for="answer_2">–û—Ç–≤–µ—Ç 2</label>
                    <input type="text" name="answer_2" id="answer_2" value="{{ task.answer_2 or '' }}" autocomplete="off">
                </div>
            </div>
        </div>

        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π/–æ—Å–æ–±—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ -->
        <div id="specialAnswers" {% if task.answer_count != 0 %}style="display:none"{% endif %}>
            <div class="form-group">
                <label for="answer_text">–û—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç)</label>
                <textarea name="answer_text" id="answer_text" class="answer-textarea" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç">{{ task.answer_text or '' }}</textarea>
                <small class="form-hint">–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∑–∞–¥–∞–Ω–∏–π, –≥–¥–µ –æ—Ç–≤–µ—Ç –Ω–µ —á–∏—Å–ª–æ (—Å—Ç—Ä–æ–∫–∞/–∫–æ–¥/–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫).</small>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <a href="{{ url_for('tasks_list', ege=task.ege_number) }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
    
    <div class="danger-zone card">
        <h3>‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
        <form action="{{ url_for('task_delete', task_id=task.id) }}" method="POST" 
              onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')">
            <button type="submit" class="btn btn-danger">üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
    </div>
</div>

<script>
function toggleSecondAnswer() {
    const count = document.getElementById('answer_count').value;
    const group = document.getElementById('answer2Group');
    const input2 = document.getElementById('answer_2');
    const stdWrap = document.getElementById('standardAnswers');
    const specWrap = document.getElementById('specialAnswers');
    const input1 = document.getElementById('answer_1');
    const text = document.getElementById('answer_text');

    if (count === '0') {
        if (stdWrap) stdWrap.style.display = 'none';
        if (specWrap) specWrap.style.display = 'block';
        if (group) group.style.display = 'none';
        if (input1) input1.required = false;
        if (input2) input2.required = false;
        if (text) text.required = true;
        return;
    }

    if (stdWrap) stdWrap.style.display = 'block';
    if (specWrap) specWrap.style.display = 'none';
    if (text) text.required = false;
    if (input1) input1.required = true;

    if (count === '2') {
        group.style.display = 'block';
        input2.required = true;
    } else {
        group.style.display = 'none';
        input2.required = false;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
toggleSecondAnswer();

// –ü—Ä–µ–≤—å—é –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.getElementById('image').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    const file = e.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = '<img src="' + e.target.result + '" alt="–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">';
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '';
    }
});
</script>
{% endblock %}
